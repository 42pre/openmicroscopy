<?xml version="1.0" encoding="UTF-8"?>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 * Child build file to create the app deliverables.
 * This file is only meant to be used as an imported file within the 
 * OMERO.insight master build file.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<project name="dist" default="usage">
 
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Fail at import time if the external properties this child depends upon
   * have not been defined. 
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <checkdef prop="build.dir"/> 
  <checkdef prop="base.launch.dir"/>
  <checkdef prop="base.lib.dir"/>
  <checkdef prop="base.licensefile"/> 
  <checkdef prop="app.compiled.dir"/>  
  <checkdef prop="app.config.dir"/>  
  <checkdef prop="app.lib.dir"/>
  <checkdef prop="app.mainclass"/>
  <checkdef ref="app.config"/>
  <checkdef ref="app.libs"/>
  <checkdef prop="docs.dir"/> 
  <checkdef prop="docs.userdocs.dir"/>
<checkdef prop="app.compiled.util.dir"/>  
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Settings to create the deliverables:
   *   + dist.dir: The distribution directory, where deliverables are created.
   *   + dist.jar.file: The name of the file in which the whole app will be 
   *           packaged.  This file will be output under ${dist.dir}.
   *   + dist.bundle.name: The name of the distribution bundle.  This is a
   *           compressed file containing the app jar, all required libs, 
   *           launch scripts, and install instructions.
   *   + dist.bundle.version: The version of the distribution bundle.  Together
   *           with the bundle name, it forms the name of the default bundle 
   *           file as <name>-<version>.zip.  (The extension name is dictated 
   *           by the compression algorithm used.)  Other platform-specific
   *           bundles follow the same naming convention, except they add a
   *           platform-specific postfix, like <name>-<version>-OSX.zip for
   *           the Mac OS X bundle.
   *   + dist.launch.scripts: All launch scripts to go in the default bundle.
   *   + dist.installfile: The install instructions to include in the
   *           default bundle.
   *   + dist.app.lib.dir.name: The name of the ${app.lib.dir}.
   *   + dist.app.config.dir.name: The name of the ${app.config.dir}.
   *   + dist.osx.icon: The icon to use for the Mac OS X client.
   *   + dist.osx.stub: The stub file for the Mac OS X client.
   *   + dist.osx.stub.name: The name of the above file.
   *   + dist.osx.installfile: The install instructions to include in the 
   *           Mac OS X bundle.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
  <property name="dist.dir" location="${build.dir}/dist"/>
  <property name="dist.jar.file" value="omero.insight.jar"/>
  <property name="dist.bundle.name" value="omero.insight"/> 
  <property name="dist.bundle.version" value="Beta-4.1.0-DEV"/>
  <fileset id="dist.launch.scripts" dir="${base.launch.dir}">
    <include name="*.sh"/>
    <include name="*.bat"/> 
  </fileset> 
  <property name="dist.installfile" 
            location="${base.launch.dir}/INSTALL.txt"/> 
  <basename property="dist.app.lib.dir.name" file="${app.lib.dir}"/>
  <basename property="dist.app.config.dir.name" file="${app.config.dir}"/>
  <property name="dist.vmparameters" value="-Xms256M -Xmx512M"/>
  <property name="dist.osx.icon" 
            location="${base.launch.dir}/osx/omeroinsight.icns"/>
  <property name="dist.osx.stub" 
            location="${base.launch.dir}/osx/JavaApplicationStub"/> 
  <property name="dist.osx.stub.name" value="JavaApplicationStub"/> 
  <property name="dist.osx.installfile" 
            location="${base.launch.dir}/osx/INSTALL"/>
  <property name="dist.exe4j.home" value="/opt/exe4j"/>
  <property name="dist.win.exename" value="OMERO.insight"/>
  <property name="dist.win.icon"
            location="${base.launch.dir}/win/omeroinsight.ico"/>
  <property name="dist.util.name" value="omero-clients-util"/>
  <property name="dist.util.dir" location="${dist.dir}/util"/>
  <property name="distEditor.osx.icon" 
	            location="${base.launch.dir}/osx/editorIcon.icns"/>
  <property name="distEditor.jar.file" value="omero.editor.jar"/>
  <property name="distEditor.bundle.name" value="omero.editor"/> 
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
    * Verify the app is good for distribution and create ${dist.dir}.
    * First the whole app and test dirs are removed and then new ones are
    * re-generated with all app and test code.  Tests are run and if a failure
    * occurs, the build is halted.  This way, the app can't be released unless 
    * all tests pass.  
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="dist-init" depends="app.clean,test.clean,test">
    <mkdir dir="${dist.dir}"/>
  </target>
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
    * Checks to see if EXE4J is available for Windows build targets.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="exe4j-check-exists">
    <condition property="dist.exe4j.exists">
      <available file="${dist.exe4j.home}/bin/ant.jar"/>
    </condition>
  </target>

  <target name="exe4j-echo-on-missing" unless="dist.exe4j.exists">
    <echo message="exe4j not present at ${dist.exe4j.home}/bin/ant.jar, skipping exe4j tasks."/>
  </target>

  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
    * Prepares the EXE4J Ant plug-in for Windows build targets.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="exe4j-init" depends="exe4j-check-exists,exe4j-echo-on-missing" if="dist.exe4j.exists">
    <echo message="exe4j present at ${dist.exe4j.home}, preparing exe4j tasks."/>
      <taskdef name="exe4j"
               classpath="${dist.exe4j.home}/bin/ant.jar"
               classname="com.exe4j.Exe4JTask"/>
  </target>
 
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Package the whole app into the ${dist.jar.file} under ${dist.dir}.
   * The whole content of the ${app.compiled.dir} is jar'ed and a suitable
   * manifest is generated that links all the required libraries.  That is
   * all libraries defined by app.libs.  The path of each library file is
   * specified in the Class-Path header to be relative to the ${app.lib.dir}.
   * For example, an xxx.jar shows up in the header as {lib}/xxx.jar, where
   * {lib} is the name of the ${app.lib.dir}.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="jar" depends="dist-init">
    <pathconvert property="dist.jar.manifest.cp" 
                 pathsep=" " 
                 dirsep="/" 
                 refid="app.libs">
      <map from="${base.lib.dir}" to="${dist.app.lib.dir.name}"/>                
    </pathconvert>      
    <jar destfile="${dist.dir}/${dist.jar.file}">
      <fileset dir="${app.compiled.dir}"/>
      <manifest>
        <attribute name="Created-By" value="OMERO Development Team"/>
        <attribute name="Class-Path" value="${dist.jar.manifest.cp}"/>
        <attribute name="Main-Class" value="${app.mainclass}"/>
      </manifest> 
    </jar>
  </target> 
 
	  <target name="jar-util" depends="dist-init">
	    <pathconvert property="dist.jar.manifest.cp" 
	                 pathsep=" " 
	                 dirsep="/" 
	                 refid="app.libs">
	      <map from="${base.lib.dir}" to="${dist.app.lib.dir.name}"/>                
	    </pathconvert>   
	    <jar destfile="${dist.dir}/${dist.util.name}-${dist.bundle.version}.jar">
	      <fileset dir="${app.compiled.util.dir}"/>
	    	<fileset dir="${base.lib.dir}" includes="${ivy.module}.jar"/>
	    	<manifest>
	    	        <attribute name="Created-By" value="OMERO Development Team"/>
	    	      </manifest> 
	    </jar>
	  </target> 
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Creates the default distribution bundle under ${dist.dir}.
   * This is a zip file whose name is set to 
   * ${dist.bundle.name}-${dist.bundle.version}.zip 
   * and whose contents are:
   *   + A config dir, containing all the app.config files.  The dir name is
   *     set to the name of the ${app.config.dir}.
   *   + A lib dir, containing all the app.libs files.  The dir name is set
   *     to the name of the ${app.lib.dir}.
   *   + The app jar file, ${dist.jar.file}.
   *   + The launch scripts, dist.launch.scripts.
   *   + The install instructions, ${dist.installfile}.
   *   + The license file, ${base.licensefile}. 
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
  <target name="dist"
          depends="jar, jar-util"
          description="Build and package the app for distribution."> 
    <zip destfile="${dist.dir}/${dist.bundle.name}-${dist.bundle.version}.zip">
      <zipfileset refid="app.config" prefix="${dist.app.config.dir.name}"/>
      <zipfileset refid="app.libs" prefix="${dist.app.lib.dir.name}"/> 
      <fileset dir="${dist.dir}" includes="${dist.jar.file}"/>
      <zipfileset refid="dist.launch.scripts" filemode="775"/>
      <fileset file="${dist.installfile}"/>
      <zipfileset file="${base.licensefile}" fullpath="LICENSE"/> 
    </zip> 
  </target>

  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Creates the Windows distribution bundle under ${dist.dir}.
   * This is a zip file whose name is set to 
   * ${dist.bundle.name}-${dist.bundle.version}-win.zip 
   * and whose contents are:
   *   + A config dir, containing all the app.config files.  The dir name is
   *     set to the name of the ${app.config.dir}.
   *   + The OMERO.insight application.  That is, the .app dir embedding the app
   *     jar file, all the the app.libs files, and Windows exe.
   *   + The license file, ${base.licensefile}. 
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="dist-win" depends="jar,exe4j-init"
          if="dist.exe4j.exists"
          description="Build an package the app for Windows distribution.">
    <echo message="Setting exe as: ${exe_location}."/>
    <copy tofile="${build.dir}/Insight.exe4j"
          file="build/Insight_template.exe4j"
          overwrite="true">
      <filterset>
        <filter token="MAIN_CLASS" value="${app.mainclass}"/>
        <!-- exe4j exe names have to be relative paths for some reason. Please
             leave the "app" directory prefix and do not replace with
             ${app.dir} or you will get strange errors. -->
		<filter token="EXE_NAME" value="app/${dist.win.exename}"/>
        <filter token="APP_NAME" value="OMERO.insight"/>
        <filter token="ICON_FILE" value="${dist.win.icon}"/>
        <filter token="VM_PARAMETERS" value="${dist.vmparameters}"/>
      </filterset>
    </copy>
    <exe4j projectfile="${build.dir}/Insight.exe4j"/>
    <zip destfile=
           "${dist.dir}/${dist.bundle.name}-${dist.bundle.version}-win.zip">
      <zipfileset refid="app.config" prefix="${dist.app.config.dir.name}"/>
      <zipfileset dir="${app.dir}" includes="lib/*"/>
      <zipfileset file="${app.dir}/${dist.win.exename}.exe"/>
      <zipfileset file="${base.licensefile}" fullpath="LICENSE"/> 
      <zipfileset dir="${dist.dir}" includes="${dist.jar.file}"/>
    </zip> 
  </target>
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Creates the Mac OS X distribution bundle under ${dist.dir}.
   * This is a zip file whose name is set to 
   * ${dist.bundle.name}-${dist.bundle.version}-OSX.zip 
   * and whose contents are:
   *   + A config dir, containing all the app.config files.  The dir name is
   *     set to the name of the ${app.config.dir}.
   *   + The OMERO.insight application.  That is, the .app dir embedding the app
   *     jar file, all the the app.libs files, and Mac OS X specific config.
   *   + The install instructions, ${dist.osx.installfile}.
   *   + The license file, ${base.licensefile}. 
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->  
  <target name="dist-osx"
          depends="jar"
          description="Build and package the app for OS X distribution.">
    <jarbundler dir="${dist.dir}"
                name="OMERO.insight"
                mainclass="${app.mainclass}"
                version="${dist.bundle.version}"
                infostring="OMERO.insight Java Client, ${dist.bundle.version}"
                aboutmenuname="OMERO.insight"
                screenmenu="true" 
                icon="${dist.osx.icon}"
                stubfile="${dist.osx.stub}" 
               	jvmversion="1.5+"
                vmoptions="${dist.vmparameters}">
      <jarfileset refid="app.libs"/>
      <jarfileset dir="${dist.dir}" includes="${dist.jar.file}"/>
    </jarbundler>  
    <zip destfile=
           "${dist.dir}/${dist.bundle.name}-${dist.bundle.version}-OSX.zip">
      <zipfileset refid="app.config" prefix="${dist.app.config.dir.name}"/>
      <fileset dir="${dist.dir}" 
               includes="OMERO.insight.app/**"
               excludes="**/${dist.osx.stub.name}"/>
      <zipfileset file="${dist.osx.stub}" 
                  fullpath="OMERO.insight.app/Contents/MacOS/${dist.osx.stub.name}"
                  filemode="775"/> 
      <fileset file="${dist.osx.installfile}"/>
      <zipfileset file="${base.licensefile}" fullpath="LICENSE"/> 
    </zip> 
  </target> 

  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
  * Creates the Mac OS X distribution bundle under ${dist.dir}.
  * This is a zip file whose name is set to 
  * ${dist.bundle.name}-${dist.bundle.version}-OSX.zip 
  * and whose contents are:
  *   + A config dir, containing all the app.config files.  The dir name is
  *     set to the name of the ${app.config.dir}.
  *   + The OMERO.insight application.  That is, the .app dir embedding the app
  *     jar file, all the the app.libs files, and Mac OS X specific config.
  *   + The install instructions, ${dist.osx.installfile}.
  *   + The license file, ${base.licensefile}. 
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->  
  <target name="distEditor-osx"
	        depends="jar"
	        description="Build and package the app for OS X distribution.">
  <jarbundler dir="${dist.dir}"
	        name="OMERO.editor"
	        mainclass="${app.mainclass}"
	        version="${dist.bundle.version}"
	        infostring="OMERO.editor Java Client, ${dist.bundle.version}"
	        aboutmenuname="OMERO.editor"
	        screenmenu="true" 
	        icon="${distEditor.osx.icon}"
	        stubfile="${dist.osx.stub}" 
	        jvmversion="1.5+"
	        vmoptions="-Xms256M -Xmx512M"
  			arguments="containerEditor.xml">
	  <jarfileset refid="app.libs"/>
	  <jarfileset dir="${dist.dir}" includes="${dist.jar.file}"/>
  </jarbundler>  
	  <zip destfile=
	         "${dist.dir}/${distEditor.bundle.name}-${dist.bundle.version}-OSX.zip">
	     <zipfileset refid="app.config" prefix="${dist.app.config.dir.name}"/>
	     <fileset dir="${dist.dir}" 
	               includes="OMERO.editor.app/**"
	               excludes="**/${dist.osx.stub.name}"/>
	     <zipfileset file="${dist.osx.stub}" 
	                  fullpath="OMERO.editor.app/Contents/MacOS/${dist.osx.stub.name}"
	                  filemode="775"/> 
	     <fileset file="${dist.osx.installfile}"/>
	     <zipfileset file="${base.licensefile}" fullpath="LICENSE"/> 
	  </zip> 
  </target> 
	
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Creates the documentation bundle under ${dist.dir}.
   * This is a zip file whose name is set to 
   * ${dist.bundle.name}-${dist.bundle.version}-doc.zip 
   * and whose contents are the javadoc and all other project documentation.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
  <target name="dist-docs"
          depends="docs"
          description="Create the full documentation bundle."> 
    <mkdir dir="${dist.dir}"/> 
    <zip 
      destfile="${dist.dir}/${dist.bundle.name}-${dist.bundle.version}-doc.zip">
      <fileset dir="${docs.dir}"/>
    </zip> 
  </target>
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Creates the user documentation bundle under ${dist.dir}.
   * This is a zip file whose name is set to 
   * ${dist.bundle.name}-${dist.bundle.version}-userdoc.zip 
   * and whose contents are just those of the ${docs.userdocs.dir}.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
  <target name="dist-user-docs"
          depends="xdocs"
          description="Create the user documentation bundle."> 
    <mkdir dir="${dist.dir}"/> 
    <zip 
      destfile="${dist.dir}/${dist.bundle.name}-${dist.bundle.version}-userdoc.zip">
      <fileset dir="${docs.userdocs.dir}"/>
    </zip> 
  </target>
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Remove all output generated by the targets within this file. 
   * This target simply deletes the ${dist.dir}, relying on the fact that all
   * other targets output under this dir.  As long as dir mapping props stick
   * to this rule, new targets can be added without modifying this one.
   * Should a target output dir need to be mapped to a dir outside of
   * ${dist.dir}, then an explicit delete has to be added here.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="clean"
          description="Remove all output generated by dist targets.">
    <delete dir="${dist.dir}"/>
  </target> 
  
  <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   * Output a list of available targets.
   * This is the list of all public targets exported by this file.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
  <target name="usage"
          description="List available distribution targets.">
    <echo level="info">
Distribution targets:
--------------------- 
  dist: Creates the default distribution bundle under ${dist.dir}.
  dist-osx: Creates the Mac OS X distribution bundle under ${dist.dir}.
  dist-docs: Create the full documentation bundle under ${dist.dir}. 
  dist-user-docs: Create the user documentation bundle under ${dist.dir}. 
  dist.clean: Remove ${dist.dir}. 
    </echo> 
  </target>  
 
</project> 
