<icegrid>

<!--
    OMERO.grid Application Descriptor
    Copyright 2008 Glencoe Software, Inc.  All Rights Reserved.
    Use is subject to license terms supplied in LICENSE.txt
-->

    <properties id="Blitz">
      <property name="Ice.Default.CollocationOptimized" value="0"/>
    </properties>

    <properties id="Repository">
      <property name="omero.repo.wait" value="300"/><!-- seconds -->
    </properties>

    <properties id="Basics">
      <property name="Ice.MessageSizeMax" value="65536"/> <!-- 64 MB -->
      <property name="Ice.Override.ConnectTimeout" value="5000"/>
    </properties>

    <properties id="SingleThreaded">
      <property name="Ice.ThreadPool.Client.Size" value="1"/>
      <property name="Ice.ThreadPool.Client.SizeMax" value="1"/>
      <property name="Ice.ThreadPool.Server.Size" value="1"/>
      <property name="Ice.ThreadPool.Server.SizeMax" value="1"/>
    </properties>

    <properties id="MultiThreaded">
      <property name="Ice.ThreadPool.Client.Size" value="2"/>
      <property name="Ice.ThreadPool.Client.SizeMax" value="50"/>
      <property name="Ice.ThreadPool.Server.Size" value="10"/>
      <property name="Ice.ThreadPool.Server.SizeMax" value="100"/>
    </properties>

    <server-template id="BlitzTemplate">
      <parameter name="index"/>
      <parameter name="config" default="default"/>
      <server id="Blitz-${index}" exe="bin/omero" activation="always">
        <option>server</option>
        <option>blitz</option>
        <option>-Domero.name=Blitz-${index}</option>
        <env>${PYTHONPATH}</env>
        <adapter name="BlitzAdapter" replica-group="BlitzAdapters" register-process="true" endpoints="tcp"/>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Blitz"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
          <property name="omero.name" value="${server}"/>
        </properties>
      </server>
    </server-template>

    <server-template id="WinBlitzTemplate">
      <parameter name="index"/>
      <parameter name="config" default="default"/>
      <server id="Blitz-${index}" exe="java" activation="always" pwd="${OMERO_HOME}">
        <option>-Dlog4j.configuration=etc\\winlog4j.xml</option>
        <option>-Xmx400M</option>
        <option>-Djava.awt.headless=true</option>
        <option>-Domero.name=Blitz-${index}</option>
        <option>-jar</option>
        <option>lib\server\blitz.jar</option>
        <adapter name="BlitzAdapter" replica-group="BlitzAdapters" register-process="true" endpoints="tcp"/>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Blitz"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
        </properties>
      </server>
    </server-template>

    <server-template id="RepositoryTemplate">
      <parameter name="index"/>
      <parameter name="dir"/>
      <parameter name="config" default="default"/>
      <server id="Repository-${index}" exe="java" activation="always" pwd="${OMERO_HOME}">
        <option>-Dlog4j.configuration=etc/log4j.xml</option>
        <option>-Xmx400M</option>
        <option>-Djava.awt.headless=true</option>
        <option>-Domero.name=Repository-${index}</option>
        <option>-Domero.repo.dir=${dir}</option>
        <option>-jar</option>
        <option>lib/server/blitz.jar</option>
        <option>OMERO.repository</option>
        <adapter name="RepositoryAdapter" register-process="true" endpoints="tcp">
          <object identity="Repository-${index}" type="::omero::grid::InternalRepository"/>
        </adapter>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
          <properties refid="Repository"/>
        </properties>
      </server>
    </server-template>

    <server-template id="IndexerTemplate">
      <parameter name="index"/>
      <parameter name="config" default="default"/>
      <server id="Indexer-${index}" exe="bin/omero" activation="always">
        <option>server</option>
        <option>indexer</option>
        <option>-Domero.name=${server}</option>
        <env>${PYTHONPATH}</env>
        <adapter name="IndexerAdapter" register-process="true" endpoints="tcp"/>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Blitz"/>
          <properties refid="Basics"/>
          <properties refid="SingleThreaded"/>
        </properties>
      </server>
    </server-template>

    <server-template id="WinIndexerTemplate">
      <parameter name="index"/>
      <parameter name="config" default="default"/>
      <server id="Indexer-${index}" exe="java" activation="always" pwd="${OMERO_HOME}">
        <option>-Dlog4j.configuration=etc\\winlog4j.xml</option>
        <option>-Xmx256M</option>
        <option>-Djava.awt.headless=true</option>
        <option>-Domero.name=Indexer-${index}</option>
        <option>-jar</option>
        <option>lib\server\blitz.jar</option>
        <option>ome.fulltext</option>
        <adapter name="IndexerAdapter" register-process="true" endpoints="tcp"/>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Blitz"/>
          <properties refid="Basics"/>
          <properties refid="SingleThreaded"/>
        </properties>
      </server>
    </server-template>

    <server-template id="WebTemplate">
      <parameter name="act" default="on-demand"/>
      <server id="Web" exe="python" activation="${act}" pwd="${OMEROPY_HOME}omeroweb">
        <option>manage.py</option>
        <option>runserver</option>
        <option>--noreload</option>
        <env>${PYTHONPATH}</env>
        <adapter name="WebAdapter" register-process="true" endpoints="tcp" server-lifetime="false"/>
      </server>
    </server-template>

    <server-template id="ProcessorTemplate">
      <parameter name="index"/>
      <parameter name="dir"/>
      <parameter name="exe" default="python"/>
      <server id="Processor-${index}" exe="${exe}" activation="always">
        <option>${OMEROPY_HOME}runProcessor.py</option>
        <env>${PYTHONPATH}</env>
        <adapter name="ProcessorAdapter" register-process="true" endpoints="tcp">
          <object identity="Processor-${index}" type="::omero::grid::Processor"/>
        </adapter>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
          <properties refid="Repository"/>
          <property name="omero.repo.dir" value="${dir}"/>
        </properties>
      </server>
    </server-template>

    <server-template id="TablesTemplate">
      <parameter name="index"/>
      <parameter name="dir"/>
      <parameter name="exe" default="python"/>
      <server id="Tables-${index}" exe="${exe}" activation="always">
        <option>${OMEROPY_HOME}runTables.py</option>
        <env>${PYTHONPATH}</env>
        <adapter name="TablesAdapter" register-process="true" endpoints="tcp">
          <object identity="Tables-${index}" type="::omero::grid::Tables"/>
        </adapter>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
          <properties refid="Repository"/>
          <property name="omero.repo.dir" value="${dir}"/>
        </properties>
      </server>
    </server-template>

    <server-template id="FSTemplate">
      <parameter name="exe" default="python"/>
      <server id="FSServer" exe="${exe}" activation="always" pwd="${OMERO_HOME}">
        <option>${OMEROPY_HOME}omero/fs/fsServer.py</option>
        <env>${PYTHONPATH}</env>
        <adapter name="omerofs.MonitorServer" register-process="true" endpoints="tcp">
          <object identity="FSServer" type="::monitors::MonitorServer"/>
        </adapter>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
        </properties>
      </server>
    </server-template>

    <server-template id="DropBoxTemplate">
      <parameter name="exe" default="python"/>
      <server id="DropBox" exe="${exe}" activation="always" pwd="${OMERO_HOME}">
        <option>${OMEROPY_HOME}omero/fs/fsDropBox.py</option>
        <env>${PYTHONPATH}</env>
        <adapter name="omerofs.DropBox" register-process="true" endpoints="tcp"/>
        <properties>
          <properties refid="Profile"/>
          <properties refid="Basics"/>
          <properties refid="MultiThreaded"/>
        </properties>
      </server>
    </server-template>

    <server-template id="ShellTemplate">
      <parameter name="id"/>
      <parameter name="exe" default="python"/>
      <parameter name="act" default="always"/>
      <server id="${id}" exe="${exe}" activation="${act}">
        <option>lib/python/shellserver.py</option>
        <option>${id}</option>
        <adapter name="${id}Adapter" register-process="true" endpoints="tcp"/>
      </server>
    </server-template>

    <server-template id="IcePatch2Template">
       <parameter name="instance-name" default="${application}.IcePatch2"/>
       <parameter name="endpoints" default="default"/>
       <parameter name="directory"/>
       <server id="${instance-name}" exe="icepatch2server" application-distrib="false" activation="always">
         <adapter name="IcePatch2" endpoints="${endpoints}">
           <object identity="${instance-name}/server" type="::IcePatch2::FileServer"/>
         </adapter>
         <properties>
            <property name="IcePatch2.Admin.Endpoints" value="tcp -h 127.0.0.1"/>
            <property name="IcePatch2.Admin.RegisterProcess" value="1"/>
            <property name="IcePatch2.InstanceName" value="${instance-name}"/>
            <property name="IcePatch2.Directory" value="${directory}"/>
         </properties>
       </server>
    </server-template>

    <server-template id="Glacier2Template">
       <parameter name="instance-name" default="${application}.Glacier2"/>
       <parameter name="client-endpoints"/>
       <parameter name="server-endpoints"/>
       <parameter name="session-timeout" default="0"/>
       <server id="${instance-name}" exe="glacier2router" activation="always">
         <properties>
           <properties refid="Basics"/>
           <property name="Glacier2.Client.Endpoints" value="${client-endpoints}"/>
           <property name="Glacier2.Server.Endpoints" value="${server-endpoints}"/>
           <property name="Glacier2.InstanceName" value="${instance-name}"/>
           <property name="Glacier2.SessionTimeout" value="${session-timeout}"/>
           <property name="Glacier2.PermissionsVerifier" value="BlitzVerifier@BlitzAdapters"/>
           <property name="Glacier2.SessionManager" value="BlitzManager@BlitzAdapters"/>
           <property name="Glacier2.Client.ForwardContext" value="1"/>
         </properties>
       </server>
     </server-template>

    <service-template id="StormTemplate">
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>
      <service name="${instance-name}" entry="IceStormService,33:createIceStorm">
        <dbenv name="${service}"/>
        <adapter name="${service}.TopicManager" id="${instance-name}.TopicManager" endpoints="${topic-manager-endpoints}">
          <object identity="${instance-name}/TopicManager" type="::IceStorm::TopicManager"/>
        </adapter>
        <adapter name="${service}.Publish" id="${instance-name}.Publish" endpoints="${publish-endpoints}"/>
        <properties>
          <property name="Ice.Trace.Network" value="0"/>
          <property name="${service}.InstanceName" value="${instance-name}"/>
          <property name="${service}.Flush.Timeout" value="${flush-timeout}"/>
          <property name="${service}.Trace.Subscriber" value="1"/>
          <property name="${service}.Trace.Topic" value="1"/>
          <property name="${service}.Trace.TopicManager" value="1"/>
        </properties>
      </service>
    </service-template>

    <server-template id="StormTemplate">
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>
      <icebox id="${instance-name}" exe="icebox" activation="always">
        <env>DYLD_LIBRARY_PATH=lib:$DYLD_LIBRARY_PATH</env>
        <env>LD_LIBRARY_PATH=lib:$LD_LIBRARY_PATH</env>
        <service-instance template="StormTemplate"
            instance-name="${instance-name}"
            topic-manager-endpoints="${topic-manager-endpoints}"
            publish-endpoints="${publish-endpoints}"
            flush-timeout="${flush-timeout}"/>
        <properties>
          <property name="IceBox.InheritProperties" value="1"/>
          <property name="Ice.Override.ConnectTimeout" value="5000"/>
        </properties>
      </icebox>
    </server-template>

    <replica-group id="BlitzAdapters">
      <load-balancing type="adaptive" load-sample="5" n-replicas="2"/>
      <object identity="BlitzVerifier" type="::Glacier2::PermissionVerifier"/>
      <object identity="BlitzManager" type="::Glacier2::SessionManager"/>
    </replica-group>

</icegrid>
