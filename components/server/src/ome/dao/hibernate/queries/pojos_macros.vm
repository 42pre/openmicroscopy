## MACROS
## Notes:
## $abbrev, $class
## $do{Project|Dataset|CategoryGroup|Category|Classification}
## $do{Image|Dataset}Annotation{Owner}
## Options::
## !$doId implies the rootNodeId or imageIds set was null
## $doExperimenter
## $do{each ALGORITHM. see Pojos}
## 
#####################################################
#macro(select)
select ${abbrev} from ${class} ${abbrev}
#end
#####################################################
## USERS/GROUPS
#####################################################
#macro(user $abbrev)left outer join fetch ${abbrev}.experimenter as ${abbrev}_exp
	left outer join fetch ${abbrev}.experimenter.group as ${abbrev}_exp_grp
	left outer join fetch ${abbrev}.experimenter.groups as ${abbrev}_exp_grps	
#end
#macro(mexuser $abbrev)left outer join fetch ${abbrev}.moduleExecution as ${abbrev}_mex
	left outer join fetch ${abbrev}_mex.experimenter as ${abbrev}_exp
	left outer join fetch ${abbrev}_mex.experimenter.group as ${abbrev}_exp_grp
	left outer join fetch ${abbrev}_mex.experimenter.groups as ${abbrev}_exp_grps	
#end
#####################################################
## ANNOTATIONS
#####################################################
#macro(ifDatasetAnnotation)
#if($doDatasetAnnotation)
	left outer join fetch d.datasetAnnotations as d_ann
	#mexuser("d_ann")
#end
#end
#####################################################
#macro(ifImageAnnotation)
#if($doImageAnnotation)
	left outer join fetch i.imageAnnotations as i_ann
	#mexuser("i_ann")
#end
#end
#####################################################
## LEAVES
#####################################################
#macro(ifImage)
#if($doImage)
	left outer join fetch i.group as i_g
	left outer join fetch i.imagePixel as i_pix
	left outer join fetch i_pix.repository as i_pix_rep
	#user("i")
#ifImageAnnotation()
#end
#end
#####################################################
## HIERARCHY-Components
#####################################################
#macro(ifCategoryGroup)
#if($doCategoryGroup)
	left outer join fetch cg.categories as c
	#mexuser("cg")
#end
#end
#####################################################
#macro(ifCategory)
#if($doCategory)
	#mexuser("c")
#end
#end
#####################################################
#macro(ifClassification)
#if($doClassification)
	left outer join fetch c.classifications as cla
	left outer join fetch cla.image as i
	#mexuser("cla")
#ifImage()
#end
#end
#####################################################
#macro(ifProject)
#if($doProject)
	left outer join fetch p.group as p_g
	left outer join fetch p.datasets as d
	#user("p")
#end
#end
#####################################################
#macro(ifDataset)
#if($doDataset)
	left outer join fetch d.group as d_g
	#user("d")
#if(!$noLeaves)
	left outer join fetch d.images as i
#ifImage()
#end
#ifDatasetAnnotation()
#end
#end
#####################################################
## HIERARCHIES
#####################################################
#macro(topDownHierarchy)
#ifProject()
#ifDataset()
#ifCategoryGroup()
#ifCategory()
#ifClassification()
#end
#####################################################
#macro(bottomUpHierarchy)
#ifImage()
#if($doDataset)
	left outer join fetch i.datasets as d
	left outer join fetch d.group as d_g	  
	#user("d")
#ifDatasetAnnotation()	
#if($doProject)	
	left outer join fetch d.projects as p
	left outer join fetch p.group as p_g 
	#user("p")
#end
#end
#if($doClassification)
	left outer join fetch i.classifications as cla 
	#mexuser("cla")
#if($doCategory)	
	left outer join fetch cla.category as c
	#mexuser("c")
#if($doCategoryGroup)	
	left outer join fetch c.categoryGroup as cg
	#mexuser("cg")
#end
#end
#end
#end
#####################################################
## WHERE
#####################################################

#macro(id)
#if($noIds)
		true = true
#else
		${abbrev}.id = :id
#end
#end
#macro(idlist)
#if($noIds)	
		true = true
#else
		${abbrev}.id in (:id_list)
#end
#end
#macro(imagelist)
#if($noIds)
		true = true
#else
		i.id in (:id_list)
#end
#end
#####################################################
#macro(filters)
#if($doDataset)
		and ( d.name != 'ImportSet' or d is null )
#if($doDatasetAnnotation)
		and ( d_ann.valid = true or d_ann is null ) 
#if($doAnnotationOwner)
		and ( d_ann_exp = :ann_owner or d_ann_exp is null )
#end
#end
#end
## TODO this can possibly leave when pojo_anns moves to its own query builder
#if($doImage)
#if($doImageAnnotation)
		and ( i_ann.valid = true or i_ann is null )
#if($doAnnotationOwner)
		and ( i_ann_exp = :ann_owner or i_ann_exp is null )
#end
#end
#end
#if($doClassification)
		and ( cla.valid = true or cla is null )
#end
#end
#####################################################
#macro(exp_select $exp)
#if($doGroup)
		and ( $exp is null or $exp in (select user.id from Experimenter user where user.group = :grp ) )
#elseif($doExperimenter)
		and ( $exp is null or $exp = :exp )
#else 
## This should only output if doGroup or doExperimenter
#end
#end

#macro(typeExperimenter)
## TODO or just the top level here?	
#if($doProject)#exp_select("p_exp")#end
#if($doDataset)#exp_select("d_exp")#end
#if($doCategoryGroup)#exp_select("cg_exp")#end
#if($doCategory)#exp_select("c_exp")#end
#if($doClassification)#exp_select("cla_exp")#end
#end

#macro(imageExperimenter)
#if(!$noLeaves)
#exp_select("i_exp")
#end
#end
#####################################################
## INTERNAL TOOLS
#####################################################
#macro(error $string)
----------------------------
Error: $string
----------------------------
#end