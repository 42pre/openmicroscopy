<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- EAR Deployment -->
<!-- ======================================================================= -->

<project name="app" default="help" basedir=".">

	<property name="artifact.packaging"  value="ear"/>
	<property file="product.properties"/>

	<property name="classpath.file" value="classpath.xml"/>
	<import file="${classpath.file}"/>

   <!--
   =======================================================================
   The EAR will be packaged to contain the EJB jar, 
   data source deployment module for our specific database, 
   deployment descriptors and thirdparty libraries.
   =======================================================================
   -->
   <target name="package" 
           description="Packages the EAR by assembling all modules and deployment descriptors">
      
      <!-- Jars; provided jars removed. -->
      <mkdir dir="${target.dir}/libs"/>
      <jars-copy type="compile" todir="${target.dir}/libs"/>
      <delete>
        <fileset dir="${target.dir}/libs" includes="commons-logging*"/>
        <fileset dir="${target.dir}/libs" includes="jboss*"/>
        <fileset dir="${target.dir}/libs" includes="log4j*"/>
        <fileset dir="${target.dir}/libs" includes="geronimo*"/>
      </delete>

      <!-- Gather all compiled services together -->
      <jar destfile="${target.dir}/libs/services.jar" basedir="${tools.dest}/service-classes"/>
      
      <!-- DataSource with replacement. -->
      <copy file="${etc.dir}/omero-ds.xml" todir="${target.dir}" />
      <replace file="${target.dir}/omero-ds.xml">
         <replacefilter token="@@@JDBC.URL@@@" value="${hibernate.connection.url}"/>
         <replacefilter token="@@@JDBC.DRIVER@@@" value="${hibernate.connection.driver_class}"/>
         <replacefilter token="@@@JDBC.USERNAME@@@" value="${hibernate.connection.username}"/>
         <replacefilter token="@@@JDBC.PASSWORD@@@" value="${hibernate.connection.password}"/>
      </replace>
      
      <jar jarfile="${target.dir}/${artifact.final.name}">
         <metainf dir="${resrc.dir}">
            <include name="application.xml" />
            <include name="jboss-app.xml" />
            <include name="jboss-login.xml" />
         </metainf>
         <fileset dir="${etc.dir}" includes="omero.properties"/>
         <fileset dir="${etc.dir}" includes="hibernate.properties"/>
         <fileset dir="${resrc.dir}" includes="ejb.properties"/>
         <fileset dir="${resrc.dir}" includes="jboss-service.xml"/>
         <fileset dir="${target.dir}/libs" includes="*.jar" />
         <fileset dir="${target.dir}" includes="omero-ds.xml"/>
         <manifest>
            <attribute name="Product-Name"      value="${product.name}"/>
            <attribute name="Product-Version"   value="${product.version}"/>
            <attribute name="Build-Date"        value="${build.time}"/>
            <attribute name="Build-JDK-Vendor"  value="${java.vendor}"/>
            <attribute name="Build-JDK-Version" value="${java.version}"/>
            <attribute name="Build-OS-Name"     value="${os.name}"/>
            <attribute name="Build-OS-Version"  value="${os.version}"/>
            <attribute name="Build-User"        value="${user.name}"/>
            <attribute name="Build-Machine"     value="${build.hostname}"/>
            <attribute name="License"           value="${product.license}"/>
         </manifest>
      </jar>

   </target>

   <target name="deploy-jboss" depends="package,deploy-ear-jboss"/>

   <target name="test"/>

   <target name="integration" depends="package">
	<antcall inheritrefs="true" target="deploy-ear-jboss"/>
	<antcall inheritrefs="true" target="wait-on-as-jboss"/>
   </target>

</project>
