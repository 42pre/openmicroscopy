<?xml version="1.0" encoding="utf-8"?>
<project name="omerojava" default="install" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
#
# Copyright 2008 Glencoe Software, Inc. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore, josh at glencoesoftware.com
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-->
    <description>
    OmeroJava interface to OmeroBlitz, provides user-friendly gateway.
    </description>

    <property name="uses.ice" value="true"/>
    <dirname property="up-two" file="${basedir}"/>
    <dirname property="up-one" file="${up-two}"/>
    <property name="import.dir"       value="${up-one}/antlib/resources"/>
    <property name="uses.ice"         value="true"/>

    <import file="${import.dir}/global.xml"/>
    <import file="${import.dir}/dependencies.xml"/>
    <import file="${import.dir}/lifecycle.xml"/>

    <defineVariables/>
    <import file="../common.xml"/>
    <target name="slice">
        <echo>no-op</echo>
    </target>

    <target name="compile" depends="generate" unless="skip.ice">
        <!-- These first tasks are "pseudo-compiles" copying in
        resources from other builds and jars to be packaged into
        the super jar -->
        <unjar src="${target.dir}/libs/ice.jar" dest="${classes.dir}">
            <patternset>
                <exclude name="META-INF/**/*"/>
            </patternset>
        </unjar>
        <copy todir="${classes.dir}">
	    <fileset dir="${resrc.dest}">
	        <include name="omero.properties"/>
	    </fileset>
            <fileset dir="${blitz.comp}/target/classes">
                <include name="omero/**/*.class"/>
                <exclude name="omero/**/_*DelD.class"/>
                <exclude name="omero/**/_*DelD$*.class"/>
                <exclude name="omero/**/_*Tie.class"/>
            </fileset>
            <fileset dir="${common.comp}/target/classes">
                <include name="ome/system/UpgradeCheck.class"/>
            </fileset>
            <fileset dir="${model.comp}/target/classes">
                <include name="ome/model/IObject.class"/>
                <include name="ome/model/ModelBased.class"/>
                <include name="ome/model/internal/*.class"/>
                <!-- Possible only need the following, but adding util
                classes for now
                 <include name="ome/util/Filterable.class"/>
                 <include name="ome/util/Filter.class"/>
                 <include name="ome/util/ModelMapper.class"/>
                 <include name="ome/util/ReverseModelMapper.class"/>
                 <include name="ome/util/Utils.class"/>
                -->
                <include name="ome/util/*.class"/>
                <include name="ome/conditions/**/*.class"/>
            </fileset>
        </copy>
        <!-- REAL compile -->
        <antcall target="lifecycle.compile" inheritAll="true" inheritRefs="true"/>
    </target>


    <target name="package" depends="lifecycle.package">
        <jar update="true" destfile="${target.dir}/${ivy.module}.jar">
            <fileset dir="${classes.dir}">
                <include name="omero.properties"/>
            </fileset>
        </jar>
    </target>

    <target name="tools-init" unless="skip.ice"/>

    <target name="tools-build" depends="tools-init,install" description="Creates all artifacts for tools/target" unless="skip.ice"/>

    <target name="tools-dist" depends="deps-resolve,tools-build" description="Copied artifacts to tools/target" unless="skip.ice">
        <mkdir dir="${target.dir}/lib/omerojava"/>
        <ivy:publish artifactspattern="${target.dir}/[module].[ext]"
            resolver="tools-resolver" pubrevision="${omero.version}"
            publishivy="false" overwrite="true"/>
    </target>

    <target name="tools-clean" depends="clean">
	<delete dir="${basedir}/target"/>
    </target>

</project>
