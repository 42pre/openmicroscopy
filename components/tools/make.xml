<?xml version="1.0" encoding="utf-8"?>
<project name="make" default="install" basedir=".">

    <property environment="make"/>
    <property name="make.ICE_HOME"    value="/usr/share/Ice"/>
    <property name="make.DESTDIR"     value="${up-two}/target/"/>
    <property name="make.LDFLAGS"     value="-fPIC"/>
    <property name="make.CXXFLAGS"    value="-fPIC -O0 -g -D_REENTRANT -Wall"/>
    <property name="make.CXX"         value="ccache g++"/>
    <property name="make.J"           value="1"/>

    <condition property="make.MAC_UNIVERSAL" value="-arch i386 -arch ppc" else="">
        <and><os family="mac"/><os family="unix"/></and>
    </condition>

    <condition property="make.MAC_TRACKING" value="--disable-dependency-tracking" else="">
        <and><os family="mac"/><os family="unix"/></and>
    </condition>

    <macrodef name="autogen">
        <attribute name="file" default="${basedir}/../autogen.sh"/>
        <attribute name="icehome" default="${make.ICE_HOME}"/>
        <attribute name="ldflags" default="${make.LDFLAGS} ${make.MAC_UNIVERSAL}"/>
        <attribute name="cxxflags" default="${make.CXXFLAGS} ${make.MAC_UNIVERSAL}"/>
        <attribute name="other" default="${make.MAC_TRACKING}"/>
        <sequential>
        <exec executable="@{file}" failonerror="true">
            <arg value="--with-ice=${make.ICE_HOME}"/>
            <arg value="--prefix=${make.DESTDIR}"/>
            <arg value="CXX=${make.CXX}"/>
            <arg value="CXXFLAGS=@{ldflags}"/>
            <arg value="LDFLAGS=@{ldflags}"/>
            <arg line="@{other}"/>
        </exec>
        </sequential>
    </macrodef>

    <macrodef name="make">
        <attribute name="dir" default="${basedir}"/>
        <attribute name="failonerror" default="true"/>
        <element name="args" implicit="yes"/>
        <sequential>
        <exec executable="make" dir="@{dir}" failonerror="@{failonerror}">
            <args/>
        </exec>
        </sequential>
    </macrodef>

    <target name="make-autogen" unless="make.NOMAKE">
        <autogen/>
    </target>

    <target name="make-build" unless="make.NOMAKE">
        <autogen/>
        
        <make dir="src"> <arg value="slice"/> </make>
        <make dir="src"> <arg value="-j${make.J}"/> </make>
        <make dir="src"> <arg value="install"/> </make>
    </target>

    <target name="make-install" unless="make.NOMAKE">
        <copy todir="../target/include">
            <fileset dir="src/slice_generated" includes="**/*.h"/>
            <fileset dir="src" includes="**/*.h" excludes="**/slice_generated/**/*"/>
        </copy>
    </target>

    <target name="make-clean" unless="make.NOMAKE">
        <!-- Doesn't fail on error to permit calling the target twice -->
        <make failonerror="false"> <arg value="clean-all"/> </make>
        <delete dir="${basedir}/src/slice_generated"/>
    </target>

</project>
