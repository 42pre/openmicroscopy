<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

{% comment %}
/**
 * omero_image - django html template
 * 
 * Copyright (c) 2007, 2008 Glencoe Software, Inc. All rights reserved.
 * 
 * This software is distributed under the terms described by the LICENCE file
 * you can find at the root of the distribution bundle, which states you are
 * free to use it only for non commercial purposes.
 * If the file is missing please request a copy by contacting
 * jason@glencoesoftware.com.
 */
{% endcomment %}

<html>
  <head>
    <META HTTP-EQUIV="imagetoolbar" CONTENT="no">

    <title>{% block title %}{% endblock %}</title>
	<script type="text/javascript" src="/media/js/blitzcon/jquery-1.2.1.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery.dimensions.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery-plugin-viewportImage.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery-plugin-slider.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery-plugin-postit.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery-plugin-rangewidget.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/JQuerySpinBtn.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jquery.selectboxes.js"></script>
	<script type="text/javascript" src="/media/js/blitzcon/jqDnR.js"></script>
        <script type="text/javascript" src="/media/js/blitzcon/jquery-plugin-colorbtn.js"></script>
        <script type="text/javascript" src="/media/js/blitzcon/farbtastic.js"></script>
    {% for src in extra_js %}
    <script type="text/javascript" src="{{ src }}"></script>
    {% endfor %}
    {% block extra_js %}{% endblock %}
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/snippet_viewport.css" media="all">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/snippet_header_logo.css" media="all">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/JQuerySpinBtn.css">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/jquery-plugin-slider.css">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/jquery-plugin-postit.css">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/jquery-plugin-rangewidget.css">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/farbtastic.css" media="all">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/jquery-plugin-colorbtn.css">
    <link rel="stylesheet" type="text/css" href="/media/css/blitzcon/omero_image.css" title="omero_image" media="all">
    {% for href in extra_css %}
    <link rel="stylesheet" type="text/css" href="{{ href }}">
    {% endfor %}
    {% block extra_css %}{% endblock %}

  </head>

  <body>

<!-- This needs to be placed before importing snippet_viewport -->
<script type="text/javascript">
  /* Keeping all global references organized */
  var state = {channelset: new Array(),
               curr_model: '',
               {% for c in image.getChannels %}
                 //chColor_{{ forloop.counter0 }}: '{{ c.getColor.getHtml }}',
                 chWindowStart_{{ forloop.counter0 }}: '{{ c.getWindowStart }}',
                 chWindowEnd_{{ forloop.counter0 }}: '{{ c.getWindowEnd }}',
               {% endfor %}
               wait_timeout: null
              }

  /* reset Rendering Details Channel Windows */
  function resetRDCW() {
    var cb;
    {% for c in image.getChannels %}
      $("#wblitz-ch{{ forloop.counter0 }}-color").css("background-color", $("#wblitz-ch{{ forloop.counter0 }}").css("background-color"));
      cb = function () {
        show_change($("#wblitz-ch{{ forloop.counter0 }}-cw-start").get(0), state.chWindowStart_{{ forloop.counter0 }}, 'changed');
      }
      $("#wblitz-ch{{ forloop.counter0 }}-cw-start").val(state.chWindowStart_{{ forloop.counter0 }}).unbind('change').bind('change', cb).change();
      cb = function () {
        show_change($("#wblitz-ch{{ forloop.counter0 }}-cw-end").get(0), state.chWindowEnd_{{ forloop.counter0 }}, 'changed');
      }
      $("#wblitz-ch{{ forloop.counter0 }}-cw-end").val(state.chWindowEnd_{{ forloop.counter0 }}).unbind('change').bind('change', cb).change();
    {% endfor %}
    $(".picker").get(0).hide_picker();
  }

  function applyRDCW() {
    {% for c in image.getChannels %}
      $("#wblitz-ch{{ forloop.counter0 }}").css('background-color', $("#wblitz-ch{{ forloop.counter0 }}-color").css("background-color"));
      state.chWindowStart_{{ forloop.counter0 }} = $("#wblitz-ch{{ forloop.counter0 }}-cw-start").get(0).value;
      state.chWindowEnd_{{ forloop.counter0 }} = $("#wblitz-ch{{ forloop.counter0 }}-cw-end").get(0).value;
    {% endfor %}
    resetRDCW();
    reload_image();
  }

  function show_change(obj, val, klass) {
    if (obj.value != val) {
      $(obj).addClass(klass);
    } else {
      $(obj).removeClass(klass);
    }
  }

  function reload_image(callback) {
    if (state.wait_timeout) {
      clearTimeout(state.wait_timeout);
      state.wait_timeout = null;
    }
    viewport_wait.html('');
    state.wait_timeout = setTimeout(function() {
      state.wait_timeout = null;
      viewport_wait.html('Loading...');
    }, 250);
    viewport_wait.show();
    var rcb = function () { after_img_load_cb(callback); viewport_img.unbind('load', rcb); };
    viewport_img.load( rcb );
    viewport_img.attr('src', image_url(parseInt($("#wblitz-z").html())-1,parseInt($("#wblitz-t").html())-1, $("#wblitz-quality").attr('value')));
    $(".popped").removeClass('popped');
    return true;
  }

  function show_tooltip(self, ttid) {
    var pos = $(self).parents('div').offset();
    pos.top += $(self).parents('div').height();
    pos.left -= 10;
    var tooltip = $('#' + ttid);
    tooltip.css(pos)
    .toggleClass('popped');
    if (tooltip.is('.popped')) {
      var auto = $('#' + ttid).find('.autoselect').get(0);
      if (auto) {
        auto.focus();
        auto.select();
      }
    }
  }

  function get_active_channels () {
    var channels = new Array();
    {% for c in image.getChannels %}
    if ($("#wblitz-ch{{ forloop.counter0 }}").is(".pressed")) {
      channels.push("{{ forloop.counter }}|"+
                     state.chWindowStart_{{ forloop.counter0 }}+
                     ":"+state.chWindowEnd_{{ forloop.counter0 }}+
                     "$"+rgbToHex($("#wblitz-ch{{ forloop.counter0 }}").css("background-color")));
    } else {
      channels.push("-{{ forloop.counter }}|"+
                     state.chWindowStart_{{ forloop.counter0 }}+
                     ":"+state.chWindowEnd_{{ forloop.counter0 }});
    }
    {% endfor %}
    return channels;
  }

  function image_url (z, t, q) {
    var query = "?c="+get_active_channels().join(",");
    if ('grey' == $("#wblitz-rm2").selectedValues()[0]) {
      query += "&m=g";
    }
    query += "&q=" + q;
    return "/{{ blitzcon.client_base }}/render_image/{{ image.id }}/" + z + "/" + t + "/" + query;
  }

  function prepare_link () {
    var base = location.href.match(/[^?]*/);
    var query = "?c="+get_active_channels().join(",");
    if ($("#wblitz-rm2 > *[selected]").attr('value') == "grey") {
      query += "&m=g";
    } else {
      query += "&m=c";
    }
    query += "&zm=" + $("#wblitz-zoom").attr('value');
    query += "&q=" + $("#wblitz-quality").selectedValues()[0];
    var i = viewport_img.parent();
    var x = parseInt(i.css('left'));
    var y = parseInt(i.css('top'));
    if (x < 0) {
      query += "&x=" + (-x);
    }
    if (y < 0) {
      query += "&y=" + (-y);
    }
    query += "&z=" + $("#wblitz-z").html() + "&t=" + $("#wblitz-t").html();
    return base+query;
  }

  function channel_toggle(c) {
    if (state.curr_model == 'grey') {
      $("button.pressed[@id^=wblitz-ch]").removeClass("pressed");
      $(c).addClass("pressed");
    } else {
      $(c).toggleClass("pressed");
    }
    reload_image();
  };

  function model_set(m) {
    /* Did the model change? */
    var model = $("#wblitz-rm2 > *[selected]").attr('value');
    if (model == state.curr_model) {
      /* noop */
      return;
    }
    var tcs = state.channelset;
    state.channelset = new Array();
    {% for c in image.getChannels %}
      state.channelset.push(["#wblitz-ch{{ forloop.counter0 }}", $("#wblitz-ch{{ forloop.counter0 }}").is(".pressed")]);
    {% endfor %}
    for (x in tcs) {
      if (tcs[x][1]) {
        $(tcs[x][0]).addClass("pressed");
      } else {
        $(tcs[x][0]).removeClass("pressed");
      }
    }
    if (model == 'grey') {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").addClass("forcegrey");
      {% endfor %}
      $("button.pressed[@id^=wblitz-ch]:gt(0)").removeClass("pressed");
    } else {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").removeClass("forcegrey");
      {% endfor %}
    }
    resetRDCW();
    reload_image();
    state.curr_model = model;
  }

  function model_toggle(m) {
    var tcs = state.channelset;
    state.channelset = new Array();
    {% for c in image.getChannels %}
      state.channelset.push(["#wblitz-ch{{ forloop.counter0 }}", $("#wblitz-ch{{ forloop.counter0 }}").is(".pressed")]);
    {% endfor %}
    for (x in tcs) {
      if (tcs[x][1]) {
        $(tcs[x][0]).addClass("pressed");
      } else {
        $(tcs[x][0]).removeClass("pressed");
      }
    }
    $(m).toggleClass("grey");
    if ($("#wblitz-rm2").is('.grey')) {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").addClass("forcegrey");
      {% endfor %}
      $("button.pressed[@id^=wblitz-ch]:gt(0)").removeClass("pressed");
    } else {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").removeClass("forcegrey");
      {% endfor %}
    }
    reload_image();
  };

  function zoom_check (i) {
    var percent = parseFloat($(i).attr('value').replace(/%/, ''));
    if (isNaN(percent)) {
      percent = 100;
    }
    /* Zoom window */
    viewport_img.get(0).setZoom(percent, {{ image.getWidth }}, {{ image.getHeight }});
  }

  function zoom_to_fit (only_reduce) {
    var dwidth = viewport_img.width();
    var iwidth = {{ image.getWidth }};
    percent = viewport_img.width() * 100.0 / {{ image.getWidth }};
    if (only_reduce && percent >= 100.0) {
      return;
    }
    $("#wblitz-zoom").attr('value', ''+percent);/* +'%');*/
    zoom_check($('#wblitz-zoom'));
  }


  $(document).ready(function () {
    /* Prepare the Zoom spin button */
    $("INPUT.spin-button").SpinButton({min:0});

    /* Sync with currently selected rendering model */

    {% if opts.c %}
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").removeClass('pressed');
      {% endfor %}
      {% for c in opts.c %}
        if ({{ c.i }} > 0 && {{ c.i }} <= {{ image.c_count }}) {
          $("#wblitz-ch{{ c.a|add:"-1" }}").addClass('pressed');
        }
        {% if c.s or c.e %}
          state.chWindowStart_{{ c.a|add:"-1" }} = {{ c.s }};
          state.chWindowEnd_{{ c.a|add:"-1" }} = {{ c.e }};
        {% endif %}
        {% if c.c %}
          $("#wblitz-ch{{ forloop.counter0 }}").css("background-color", '#{{ c.c }}');
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if opts.m %}
      {% ifequal opts.m "g" %}
        $("#wblitz-rm2").selectOptions('grey');
      {% else %}
        $("#wblitz-rm2").selectOptions('color');
      {% endifequal %}
    {% endif %}
    state.curr_model = $("#wblitz-rm2 > *[selected]").attr('value');

    if (state.curr_model == 'grey') {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").addClass("forcegrey");
      {% endfor %}
    }

    if (state.curr_model == 'grey') {
      {% for c in image.getChannels %}
        $("#wblitz-ch{{ forloop.counter0 }}").addClass("forcegrey");
      {% endfor %}
    }

    {% if opts.q %}
      $("#wblitz-quality").selectOptions("{{ opts.q }}");
    {% endif %}



    /* Setup pop tools */
    $(".popover > h1")
      .prepend('<div class="drop-img drop-left"></div><div class="drop-img drop-right"></div>')
      .click(function () {
        var this_popped = $(this).parent().is('.popped');
        $(".popped").removeClass('popped');
        if (this_popped) {
          $(this).parent().removeClass('popped');
        } else {
          $(this).parent().addClass('popped');
        }
        return false;
      });

    $("#wblitz-imgarea").click(function () {
      $(".popped").removeClass('popped');
    });

    $(".popclose").click(function () {
      $(".popped").removeClass('popped');
    });


    /* Prepare color picker buttons */
    $(".picker").colorbtn();

    viewport_recalc = function (dim) {
      if ($.browser.mozilla) {
        dim.width -= 25;
        dim.height -= 40;
      } else if ($.browser.safari) {
        dim.width -= 7;
      } else {
        dim.height -= 17;
      }
    }

    ///* Get the sizes right to start with */
    //calc_resize();

    /* Set Window Initial Size */
    window.resizeTo(1024,800);

    $("#wblitz-imgarea").css({position: 'absolute', top: 60});
    var layout_pos = $("#wblitz-imgarea").offset();

    $(".postit").each(function () {
      layout_pos.left += 20;
      $(this).postit()
      .css(layout_pos);
      layout_pos.top += 20;
    });

    {% for c in image.getChannels %}
      $("#wblitz-ch{{ forloop.counter0 }}-cw ").rangewidget({
	min: {{ c.getWindowMin }},
	max: {{ c.getWindowMax }} });
    {% endfor %}

    $("#rdef-postit").bind('closing', function() {$(".picker").get(0).hide_picker()});
    resetRDCW();
  });
</script>

    <div id="header">
      {% block header_content %}
      {% endblock %}
    </div>

    {% block body_content %}

    <!-- Floating boxes come on top -->
    <div id="curr-link" class="tooltipbox">
      <table>
        <tr>
          <td>
            Link to this page:
          </td>
          <td class="left">
            <img class="popclose" src="/media/img/blitzcon/close.gif" />
          </td>
        </tr>
        <tr>
          <td><input class="autoselect" type="text" size="40" value=""></td>
        </tr>
      </table>
    </div>

    <div id="metadata-postit" class="postit">
      <h1> Metadata </h1>
      <table>
        <tr>
          <td style="text-align: right;">Author:</td>
          <td>{{ image.getAuthor }}</td>
        </tr>
        <tr>
          <td style="text-align: right;">Publication:</td>
          <td>{{ image.getPublication }}</td>
        </tr>
        <tr>
          <td style="text-align: right;">Publication ID:</td>
          <td>{{ image.getPublicationId }}</td>
        </tr>
        <tr>
          <td style="text-align: right;">Created on:</td>
          <td>{{ image.getDate }}</td>
        </tr>
      </table>
    </div>

    <div id="sizes-postit" class="postit">
      <h1> Size matters </h1>
      <h2>Image Size</h2>
      <ul>
        <li>X: {{ image.getWidth }}px</li>
        <li>Y: {{ image.getHeight }}px</li>
        <li>Z: {{ image.z_count }}</li>
        <li>T: {{ image.t_count }}</li>
      </ul>
      <h2>Pixel Size</h2>
      <ul>
        <li>X: {{ image.getPixelSizeX|floatformat:4 }}&micro;m</li>
        <li>Y: {{ image.getPixelSizeY|floatformat:4 }}&micro;m</li>
        <li>Z: {{ image.getPixelSizeZ|floatformat:4 }}&micro;m</li>
      </ul>
    </div>

    <div id="rdef-postit" class="postit">
      <h1> Rendering Details </h1>
      <h2>Channel Windows</h2>
      <ul>
        {% for c in image.getChannels %}
        <li><strong>
              Channel {{ c.getEmissionWave }}:</strong> ->
              <button id="wblitz-ch{{ forloop.counter0 }}-color" class="squared picker">
                &nbsp;
              </button>
          <div id="wblitz-ch{{ forloop.counter0 }}-cw" class="rangewidget"></div>
          <!-- table>
            <tr>
              <td style="text-align: right;">Start:</td>
              <td><input id="wblitz-ch{{ forloop.counter0 }}-start" type="text" class="spin-button" /></td>
            </tr>
            <tr>
              <td style="text-align: right;">End:</td>
              <td><input id="wblitz-ch{{ forloop.counter0 }}-end" type="text" class="spin-button" /></td>
            </tr>
          </table -->
        </li>
        {% endfor %}
        <li><input type="button" value="reset" onclick="return resetRDCW();" />
            <input type="button" value="apply" onclick="return applyRDCW();" /></li>
      </ul>
    </div>

    <!-- End floating boxes -->
    <div id="wblitz">
      <!-- Top Toolbox -->
      <div id="wblitz-workarea">
        <!-- Zoom -->
        <div class="box">
          <h1>Zoom</h1>
          <input type="text" class="spin-button" id="wblitz-zoom" value="100" onchange="zoom_check(this)" size="5" />
          <button id="full-size"
                  title="1:1"
                  onclick="viewport_img.get(0).setZoom(100)" ></button>
          <button id="full-screen"
                  title="full screen"
                  onclick="viewport_img.get(0).setZoomToFit()"></button>
        </div>
        <!-- Rendering Model -->
        <div class="box">
          <h1>Rendering Options</h1>
          <div class="overview">
            <label for="wblitz-rm2">Model</label>
            <select id="wblitz-rm2" onchange="model_set(this)">
              <option value="color">Color</option>
              <option value="grey"{% if image.isGreyscaleRenderingModel %} selected="selected"{% endif %}>Greyscale</option>
            </select>
<br />
            <label for="wblitz-quality">Quality</label>
            <select id="wblitz-quality" onchange="reload_image()">
              <option value="1.0">High</option>
              <option value="0.9" selected>Good</option>
              <option value="0.7">Normal</option>
              <option value="0.5">Low</option>
            </select>
          </div>
        </div>
        <!-- Channel Buttons -->
        <div class="box">
          <h1>Channels</h1>
          {% for c in image.getChannels %}
          <button id="wblitz-ch{{ forloop.counter0 }}" class="squared{% if c.isActive %} pressed{% endif %}"
             style="background-color: {{ c.getColor.getHtml }}"
              onclick="channel_toggle(this)">
            {{ c.getEmissionWave }}
          </button>
          {% endfor %}
        </div>
        <!-- Details -->
        <div id="wblitz-details" class="box popover">
          <h1>Image Details</h1>
          <div class="overview">
             <h2>Current View</h2>
              Z = <span id="wblitz-z">?</span> of {{ image.z_count }} | T = <span id="wblitz-t">1</span> of {{ image.t_count }}
          </div>
          <div class="detail">
            <a href="#" onclick="$('#metadata-postit').toggle(); return false;">Show Metadata</a>
            <a href="#" onclick="$('#sizes-postit').toggle(); return false;">Show Sizes</a>
            <a href="#" onclick="$('#rdef-postit').toggle(); return false;">Show Rendering Details</a>
          </div>
        </div>
        <!-- Image list -->
        
        {% if dataset %}
        <div class="box popover">
          <h1>Figure images</h1>
          <div class="not-detail">
            <h2>
              <a href="" onmouseover="this.href=prepare_link()"
                 onclick="$('#curr-link input').attr('value', prepare_link()); show_tooltip(this, 'curr-link'); return false;">
                Current Image
              </a>
            </h2>
            <span style="white-space: nowrap;" title="{{ image.name }}">{{ image.shortname }}</span>
          </div>
          <div class="detail">
            <!-- Each Image -->
              {% for img in dataset.listChildren %}
                {% ifequal img.id image.id %}
                <div class="selected">
                  <img src="/{{ blitzcon.client_base }}/render_thumbnail/{{ img.id }}/" alt="{{ img.name }}"/><br>
                  <span style="white-space: nowrap;" title="{{ image.name }}">{{ image.shortname }}</span>
                </div>
                {% else %}
                <a href="/{{ blitzcon.client_base }}/img_detail/{{ img.id }}/{{ dataset.id }}/">
                  <img src="/{{ blitzcon.client_base }}/render_thumbnail/{{ img.id }}/" alt="{{ img.name }}"/><br>
                  <span style="white-space: nowrap;" title="{{ image.name }}">{{ image.shortname }}</span>
                </a>
                {% endifequal %}
              {% endfor %}
          </div>
        </div>
        {% endif %}



        <!-- Image Viewport -->
        {% include "blitzcon/snippet_viewport.thtml" %}


      </div>
    </div>
    <div id="footer">
    {% block footer_content %}
      &copy;2007/2008 Glencoe Software Inc. All rights reserved.
    {% endblock %}
    </div>

  {% endblock body_content %}
  </body>
</html>
