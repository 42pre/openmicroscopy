<?xml version="1.0" encoding="utf-8"?>
<project name="server" default="help" basedir=".">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
# 
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
# 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  DOCUMENTATION:
  ==============================================================================
  Script to deploy and undeploy our application. This functionality is
  similar to that provided by cargo, http://cargo.codehaus.org and may
  be replaced.

-->
    
	<!-- 	===============================================
		APPLICATION SERVER (AS) 
	==================================================  -->

   <property name="jboss.home" value="${env.JBOSS_HOME}"/>   
   <property name="jboss.server.config" value="default"/>
   <property name="jboss.deploy.dir" value="${jboss.home}/server/${jboss.server.config}/deploy"/>

   <target name="help">
     <echo>
  deploy --   installs all ears under ${target.dir} to ${jboss.deploy.dir}
  undeploy -- removes those same ears from ${jboss.deploy.dir}
     </echo>
   </target>

	<target name="earfiles">
		<fileset dir="${app.comp}/${target.rel}" includes="*.ear" id="ear.files"/>
	</target>

	<target name="deploy-ear-jboss" depends="check-system,earfiles">
		<copy todir="${jboss.deploy.dir}">
			<fileset refid="ear.files"/>
		</copy>
	</target>

	<target name="undeploy-ear-jboss" depends="check-system,prepare,load-groovy">
		<groovy>
       fs = project.references["ear.files"]
       jb = properties["jboss.deploy.dir"]
       fs.each { |file|
         ant.delete(file:"${jb}/${file}")
       }
		</groovy>
	</target>

	<target name="start-as-jboss" depends="check-system">
		<exec executable="${env.JBOSS_HOME}/bin/run.sh" spawn="true"/>
	</target>

	<target name="stop-as-jboss" depends="check-system">
		<exec executable="${env.JBOSS_HOME}/bin/shutdown.sh">
			<arg value="-S"/>
		</exec>
	</target>

	<target name="wait-on-as-jboss"
		depends="check-system,prepare,load-groovy"
		description="Tries to contact JBoss with increasing intervals">
		<groovy>
			jboss_home = properties["env.JBOSS_HOME"]
			status = ["${jboss_home}/bin/twiddle.sh","query","jboss.j2ee:ear=app-3.0-TRUNK.ear,jar=server-3.0-TRUNK.jar,name=QueryImpl,service=EJB3"]
			int ret = -1;
			[2,4,8,16,32].each { |i|
			  if (ret != 0) {
			    println "Waiting on JBoss..."
			    Thread.currentThread().sleep(i*1000)
			    p = status.execute()
			    p.waitFor()
			    ret = p.exitValue()
			  }
			}
		</groovy>
	</target>

</project>
