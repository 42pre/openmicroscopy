<?xml version="1.0" encoding="utf-8"?>
<project name="server" default="help" basedir=".">
    
	<!-- 	===============================================
		APPLICATION SERVER (AS) 
	==================================================  -->

   <property name="jboss.home" value="${env.JBOSS_HOME}"/>   
   <property name="jboss.server.config" value="all"/>
   <property name="jboss.deploy.dir" value="${jboss.home}/server/${jboss.server.config}/deploy"/>

   <target name="help">
     <echo>
  deploy --   installs all ears under ${target.dir} to ${jboss.deploy.dir}
  undeploy -- removes those same ears from ${jboss.deploy.dir}
     </echo>
   </target>

	<target name="filelist">
		<fileset dir="${target.dir}" includes="*.ear" id="ear.files"/>
	</target>

	<target name="deploy-ear-jboss">
		<copy todir="${jboss.deploy.dir}">
			<fileset refid="ear.files"/>
		</copy>
	</target>

	<target name="undeploy-ear-jboss">
		<groovy>
       fs = project.references["ear.files"]
       jb = properties["jboss.deploy.dir"]
       fs.each { |file|
         ant.delete(file:"${jb}/${file}")
       }
		</groovy>
	</target>

	<target name="start-as-jboss">
		<exec executable="${env.JBOSS_HOME}/bin/run.sh"/>
	</target>

	<target name="stop-as-jboss">
		<exec executable="${env.JBOSS_HOME}/bin/shutdown.sh">
			<arg value="-S"/>
		</exec>
	</target>

	<target name="wait-on-as-jboss" 
		depends="prepare,load-groovy"
		description="Tries to contact JBoss with increasing intervals">
		<groovy>
			jboss_home = properties["env.JBOSS_HOME"]
			status = ["${jboss_home}/bin/twiddle.sh","serverinfo","-l"]
			int ret = -1;
			[0,1,2,4,8,16].each { |i|
			  if (ret != 0) {
			    println "Waiting on JBoss..."
			    Thread.currentThread().sleep(i*1000)
			    p = status.execute()
			    p.waitFor()
			    ret = p.exitValue()
			  }
			}
		</groovy>
	</target>

</project>
