<?xml version="1.0" encoding="utf-8"?>
<project name="omero" default="usage" basedir=".">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
# 
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
# 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  DOCUMENTATION:
  ==============================================================================
  This is the main build script for binary distributions and replaces the 
  main build script (OMERO_HOME/build.xml) in the OMERO_HOME/dist directories. 

-->

	<!-- This overrides the classpath.file properties of all the components. -->
        <property name="ant.resources"       value="${basedir}/components/antlib/resources/"/>
	<property name="classpath.file"      value="${ant.resources}/dist-classpath.xml"/>
	<import file="${classpath.file}"/> <!-- imports global.xml -->
	<import file="${ant.resources}/multiproject.xml"/>

	<target name="classpath-define">
		<path id="omero.classpath">
			<path refid="generated.compile.classpath"/>
		</path>
	</target>
	
	<target name="usage"
		description="Usage information">
		<concat>
			<filelist dir="${import.dir}" files="usage-omero.txt"/>
		</concat>
	</target>

	<target name="update">

                <!-- copied from app/build.xml refactor -->
      <tempfile property="temp.dir" prefix="omero"/>
      <mkdir dir="${temp.dir}"/>
      <copy file="${etc.dir}/omero-ds.xml" todir="${temp.dir}" />
      <replace file="${temp.dir}/omero-ds.xml">
         <replacefilter token="@@@JDBC.URL@@@" value="${hibernate.connection.url}"/>
         <replacefilter token="@@@JDBC.DRIVER@@@" value="${hibernate.connection.driver_class}"/>
         <replacefilter token="@@@JDBC.USERNAME@@@" value="${hibernate.connection.username}"/>
         <replacefilter token="@@@JDBC.PASSWORD@@@" value="${hibernate.connection.password}"/>
      </replace>

		<jar update="true"
		  destfile="${artifact.final.name}">
			<fileset dir="${basedir}/etc">
				<include name="local.properties"/>
				<include name="local.properties.example"/>
				<include name="omero.properties"/>
				<include name="hibernate.properties"/>
			</fileset>
			<fileset dir="${temp.dir}">
				<include name="omero-ds.xml"/>
			</fileset>
		</jar>
		<delete dir="${temp.dir}"/>

		<jar update="true" 
		  destfile="blitz/blitz-${omero.version}.jar">
			<fileset dir="${basedir}/etc">
				<include name="local.properties"/>
				<include name="local.properties.example"/>
				<include name="omero.properties"/>
				<include name="hibernate.properties"/>
			</fileset>
		</jar>

	</target>

	<target name="setup-db" depends="classpath-define">
		<ant antfile="${server.comp}/build.xml" target="reload-db">
		<property name="sql.dir" value="${basedir}/sql/${omero.db.profile}"/>
		</ant>
	</target>

	<target name="earfiles">
		<fileset dir="${omero.home}" includes="*.ear" id="ear.files"/>
	</target>
	<target name="deploy" depends="deploy-ear-jboss"/>

	<target name="check" depends="classpath-define,load-groovy">

		<groovy classpathRef="generated.compile.classpath">
		println System.getProperty("java.class.path")
		sf = new ome.system.ServiceFactory()
		p = sf.getPojosService()

		s = new HashSet()
		s.add(new Long(1))
		s.add(new Long(5588))

		r = p.findCGCPaths(s,ome.api.IPojos.CLASSIFICATION_ME,None)
		</groovy>
	</target>
</project>

